<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        pre { white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
    <h1>üîç –¢–µ—Å—Ç –¥–∞–Ω–Ω—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</h1>
    <button onclick="testCompetitors()">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤</button>
    <div id="results"></div>

    <script>
        // –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π API –∫–ª–∞—Å—Å –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        class KeysAPI {
            constructor(proxyUrl = '../keys_proxy.php') {
                this.proxyUrl = proxyUrl;
            }

            async makeGet(endpoint, params = {}) {
                try {
                    const usp = new URLSearchParams({ endpoint, ...params });
                    const url = `${this.proxyUrl}?${usp.toString()}`;

                    console.log('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º GET –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏:', {
                        url: this.proxyUrl,
                        endpoint: endpoint,
                        params: params,
                        fullUrl: url
                    });

                    const response = await fetch(url, {
                        method: 'GET'
                    });

                    console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', {
                        status: response.status,
                        statusText: response.statusText,
                        ok: response.ok
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('–¢–µ–∫—Å—Ç –æ—à–∏–±–∫–∏:', errorText);
                        throw new Error(`HTTP Error: ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ API –∑–∞–ø—Ä–æ—Å–∞:', error);
                    throw error;
                }
            }

            async getCompetitors(domain, region = 'msk', perPage = 50) {
                const cleanDomain = domain.replace(/^https?:\/\//, '').replace(/\/$/, '');
                const limitedPerPage = Math.min(perPage, 500);
                
                return await this.makeGet('/report/simple/organic/concurents', {
                    domain: cleanDomain,
                    base: region,
                    per_page: limitedPerPage
                });
            }
        }

        async function testCompetitors() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="log">üîÑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤...</div>';
            
            try {
                const api = new KeysAPI();
                const data = await api.getCompetitors('arsenalmetall.by', 'msk', 10);
                
                results.innerHTML = `
                    <div class="success">‚úÖ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!</div>
                    <div class="log">
                        <h3>üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:</h3>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </div>
                    <div class="log">
                        <h3>üîç –ê–Ω–∞–ª–∏–∑ –ø–æ–ª–µ–π:</h3>
                        <pre>${analyzeDataStructure(data)}</pre>
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `
                    <div class="error">‚ùå –û—à–∏–±–∫–∞: ${error.message}</div>
                    <div class="log">
                        <h3>üîç –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:</h3>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        function analyzeDataStructure(data) {
            let analysis = '';
            
            if (Array.isArray(data)) {
                analysis += `üìã –ú–∞—Å—Å–∏–≤ –∏–∑ ${data.length} —ç–ª–µ–º–µ–Ω—Ç–æ–≤\n\n`;
                
                if (data.length > 0) {
                    const firstItem = data[0];
                    analysis += `üîç –ü–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç:\n`;
                    analysis += `–¢–∏–ø: ${typeof firstItem}\n`;
                    analysis += `–ö–ª—é—á–∏: ${Object.keys(firstItem).join(', ')}\n\n`;
                    
                    analysis += `üìù –í—Å–µ –ø–æ–ª—è –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞:\n`;
                    Object.keys(firstItem).forEach(key => {
                        analysis += `  ${key}: ${typeof firstItem[key]} = ${JSON.stringify(firstItem[key])}\n`;
                    });
                }
            } else if (typeof data === 'object') {
                analysis += `üì¶ –û–±—ä–µ–∫—Ç —Å –∫–ª—é—á–∞–º–∏: ${Object.keys(data).join(', ')}\n\n`;
                
                Object.keys(data).forEach(key => {
                    analysis += `  ${key}: ${typeof data[key]} = ${JSON.stringify(data[key])}\n`;
                });
            } else {
                analysis += `‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –¥–∞–Ω–Ω—ã—Ö: ${typeof data}\n`;
                analysis += `–ó–Ω–∞—á–µ–Ω–∏–µ: ${JSON.stringify(data)}`;
            }
            
            return analysis;
        }
    </script>
</body>
</html>
